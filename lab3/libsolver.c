#include <stdint-gcc.h>
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <sys/mman.h>

#include "libmaze.h"

// static void * __stored_ptr = NULL;
static void* (*get_ptr)(void) = NULL;
static void (*org_move_up)(maze_t*) = NULL;
static void (*org_move_down)(maze_t*) = NULL;
static void (*org_move_left)(maze_t*) = NULL;
static void (*org_move_right)(maze_t*) = NULL;
static maze_t* (*org_maze_load)(const char *) = NULL;

const int dx[] = {0, 0, -1, 1};
const int dy[] = {-1, 1, 0, 0};

const char* relativeAddressInStr[1199] = {
	"23508","226c8","22bb8","21ce0","22168","23988","23e18","23020","234d8","23760","232b0","22e20","22960","22390","21f98","21b18","23c20","23790","232d8","23d40","237d0","233e8","22f40","22a98","225c8","220a8","21c50","23d50","237f0","23038","22ba0","225f8","221b0","21d38","23e48","239b8","234e8","23058","22bb0","22cf0","22808","22310","21e78","23f60","23ad0","235e0","23130","22cc0","227b8","23c18","23780","232f0","22e40","22970","22428","21f58","21af0","23bd8","23758","23878","233f8","22f48","22a88","225b0","220c8","21c38","23d38","23868","233b8","221c8","21d40","23e40","239a0","23500","23040","22b98","22690","22180","21d18","23ac8","235d8","23128","22cb8","227b0","222e8","21e50","23f48","23ac0","23538","22e38","22968","22420","21f50","21ae8","23bd0","23750","232a8","22e18","22958","229b0","22480","21fc8","21b48","23c48","23690","231e8","22d68","22878","22370","21c90","23d78","238b0","23418","22f60","22ab8","224c8","22008","21b68","23c80","23088","22bf0","22700","221f8","21d88","23e70","239d8","23458","22fa8","22b00","22380","21eb0","23fa8","23b08","23648","231a0","22d18","22818","22228","21dd0","23730","232a0","22e00","22930","22410","21f40","21ac0","23bc0","23708","23270","22080","21c20","23d18","23858","233a8","22ef0","22a40","22548","22060","21bf0","22b70","22680","22150","21ce8","23dc8","23958","234b0","23010","22b58","22650","23a98","235b8","23108","22c78","22788","222a8","21e28","23f10","23a68","23598","21f38","21ab8","23bb8","23700","23268","22dd8","22900","223f0","21f10","21a88","23850","233a0","22ee8","22a38","22540","22058","21be8","23cf0","23838","23380","22a90","22f38","233d8","23880","23d30","21c30","220a0","22590","22980","22e48","23b80","21a70","21ef8","223d8","228c8","22da0","23218","236d0","23b40","23fd0","22c40","230c8","23570","23a40","23ed8","21de8","22270","22730","22c18","230a0","22130","22638","22b30","22fd8","23478","23908","23d98","21ca0","22108","22618","23820","23cb8","21bb8","22030","22508","229e0","22e98","23330","237e8","23cb0","22d98","23210","236c8","23b38","23fc8","21ec0","223a0","228c0","22d88","231f0","23a38","23ed0","21de0","22268","22728","22c10","23098","23540","23a30","23ec8","23900","23d90","21c98","22100","22610","22b28","22fc8","23468","238e0","23e00","22028","22500","229d8","22e90","23328","237e0","23ca8","21ba0","22018","224d8","21e70","22338","22848","22d28","23180","23630","23b78","21a68","21ef0","223d0","22a50","23848","23390","21c08","23d08","22560","22070","22df0","22928","23720","21cf8","23de0","22678","22148","23018","22b68","23950","234b8","21c18","23d10","22c08","22718","23530","23090","23e80","239f0","22200","21da0","22bd0","226d8","23b30","22388","21eb8","22d38","22850","23650","231b0","23f80","23ae8","22330","237c8","23320","21b58","23c60","22498","21fd8","22e60","22990","237a0","232e8","220f8","22f78","22ad8","238c8","23428","21c60","23d60","225d8","220c0","22f70","239f8","22208","21d98","22bc8","226d0","234f8","23050","23e78","239e0","221d0","22d30","22858","23658","231a8","23f78","23ae0","22328","21e68","22d20","22838","21fd0","22e58","22988","23798","232e0","21b50","23c50","22478","21fa8","22ed8","238c0","23420","21c58","23d58","225d0","220b8","22f68","22ac0","238a8","23400","22800","22ce8","21f30","22408","23ba8","21aa0","23288","23718","22910","22de0","23e38","23100","235b0","22780","22c70","21e38","222b0","23a80","23f18","22fe0","225a8","23d28","21c28","233f0","23898","22a80","22f30","22158","22670","23dd0","232c8","23778","22950","22e30","21fa0","22468","23c10","21b10","23398","23840","23f58","23170","23628","227f8","22ce0","21f28","22400","23ba0","21a98","23280","226b0","22b90","21d50","221c0","239b0","23e30","230f8","235a8","22778","22c68","22b20","22fc0","22050","22530","23cc8","21bd8","23368","23818","22a08","22ec0","21b98","23240","236e8","228e0","22dc8","21ee8","223c0","23b70","21a60","23258","231f8","236c0","228b8","22d80","21e10","222a0","23a50","23ef8","230b8","23560","22260","23a28","23ec0","23000","234a8","22648","22b48","21cb0","22128","23928","227a8","22458","21f90","21b00","23c00","23770","232b8","22e28","22948","22220","23290","22de8","22918","22418","21f48","21ac8","23bc8","23888","233c8","22f20","22570","22078","21bf8","23cf8","23860","233b0","22f00","22a48","226b8","22198","22668","22178","21d08","23df0","23970","23618","23160","22cd0","227d8","22300","23f28","23a90","235d0","23120","22c98","227a0","22450","21f88","21af8","23bf8","21b40","23c40","23688","231e0","22d60","22888","22368","21ea0","23fb8","23b20","22ab0","224c0","22000","21b70","23c78","237c0","23318","22e80","229d0","22580","221f0","21d80","23e68","239d0","23450","22fa0","22af8","22608","220f0","21c80","23198","22d10","22820","22230","21dc8","23e90","23a08","23528","23078","22c00","229a8","22488","21fc0","21b38","23c38","23680","231d8","22d58","22880","22360","228d8","22db0","23228","236e0","23b18","23f90","21e90","22340","22840","22cf8","23ee8","21df8","22280","22710","22be0","23068","23510","239e8","23e50","21d60","23488","23918","23d88","21c70","220e0","225f0","22ad0","22f50","23408","238a0","22518","229c0","22e70","23308","237b0","23c58","21b20","21fb0","22470","22978","21a38","21ed8","223a8","228d0","22da8","23220","236d8","23b10","23f88","21e88","22740","22c28","230a8","23548","23a48","23ee0","21df0","22278","22708","22bd8","22620","22b38","22fe8","23480","23910","23d80","21c68","220d8","225e8","22ac8","23340","237f8","23cc0","21bc0","22038","22510","229b8","22e68","23300","237a8","232c0","23768","23ad8","23f68","21e60","22320","227f0","22cd8","23168","23620","222f0","226c0","22ba8","23048","234f0","23998","23e20","21d30","221a8","225c0","22868","23668","231c0","21a50","23b58","223b0","21ed0","22d90","228a0","236a0","224a8","21fe8","22eb0","229f8","23808","23350","21bb0","23c98","224e0","22010","23438","21cc8","23db0","22630","22118","22fd0","22b08","238e8","23460","21c10","226f0","23518","23060","23e88","23a00","22218","21da8","22c38","22738","23550","23f98","23af8","22348","21e80","22d40","22860","23660","231b8","21a48","23b50","232f8","21b60","23c68","224a0","21fe0","22ea8","229f0","23800","23348","21ba8","225e0","220d0","22f88","22ae0","238d0","23430","21cc0","23da8","22628","22110","222b8","21e30","22b78","22688","234c8","23028","23dd8","23960","22160","21cf0","23278","23f30","23aa0","222c8","21e48","22c88","22790","235c0","23110","23ea0","21c00","23d00","22568","22068","22df8","22920","23728","23298","21aa8","23bb0","226a8","22b88","21d48","221b8","239a8","23e28","230f0","235a0","22770","22c60","22b18","22fb8","22048","22528","23cd8","21bd0","23360","23810","22a00","22eb8","21b90","23238","236f8","228f0","22dc0","21ee0","223b8","23b68","21a58","23250","23208","236b8","228b0","22d78","21e08","22298","23a60","23ef0","230b0","23558","22258","23a20","23eb8","22ff8","234a0","22640","22b40","21ca8","22120","23920","21cb8","23470","238f8","22b10","22fb0","22040","22520","23cd0","21bc8","23358","22a10","22ea0","22020","224f8","23ca0","21b88","23230","236f0","228e8","22db8","223c8","23b60","21a40","23200","236b0","228a8","22d70","21e00","22290","23a58","230c0","23568","22748","22c30","21dd8","22250","23a18","23eb0","22ff0","23498","220b0","225b8","23d48","21c48","233e0","23890","22a78","22f28","22098","22588","22660","22170","21d00","23de8","23968","23610","23158","22cc8","227d0","22308","23f20","23a88","235c8","23118","22c90","22798","22460","21f80","21b08","23bf0","21b30","23c30","23678","231d0","22d50","22898","22358","21e98","23fb0","23b28","22aa8","224b8","21ff8","21b80","23c90","237b8","23310","22e78","229c8","22578","221e8","21d78","23e60","239c8","23448","22f98","22af0","22600","220e8","21c78","23190","22d08","22828","22238","21dc0","23e98","23a10","23520","23070","22bf8","229a0","22490","21fb8","21b28","23c28","23670","231c8","22d48","22890","22350","21c88","23d70","238b8","23410","22f58","22aa0","224b0","21ff0","21b78","23c88","23080","22be8","226f8","221e0","21d70","23e58","239c0","23440","22f90","22ae8","22378","21ea8","23fa0","23b00","23640","23188","22d00","22830","22240","21db8","21e20","23f08","23a78","23590","230e8","22c80","22760","222c0","21e40","23ea8","23930","23af0","23008","22b50","22658","22140","21cd8","23dc0","23940","234c0","22a28","22538","226e8","21be0","23ce0","23830","23388","22ef8","22a30","22558","21f08","21a90","23b90","23d68","23248","22dd0","22908","223f8","21f20","21ab0","23578","230d0","22c58","22750","22998","21e18","23f00","23a70","23588","230e0","22090","21db0","23ce8","23828","23370","22ed0","22a20","22550","22190","21d10","22f80","228f8","223e0","21f00","21a78","23b88","23710","233c0","22f08","22a68","23f50","23ab8","235f0","23140","22c48","22758","22438","21f68","21ae0","23be0","226a0","22188","21d28","23db8","23938","235f8","23138","22cb0","227c0","222e0","22f18","22a70","225a0","22210","21d90","23e08","23978","234e0","23030","22b60","224f0","222d8","23ab0","23f40","23150","23608","227e8","22ca8","21e58","22318","23740","22940","22e10","21f78","22448","23c08","21ad8","232d0","23788","22810","22a58","22248","22088","23870","23d20","22f10","233d0","22598","22a60","21c40","23980","23df8","236a8","234d0","22698","22b80","21d20","221a0","23990","23e10","235e8","227c8","22ca0","224e8","222d0","23aa8","23f38","23148","23600","227e0","21f60","22430","23be8","21ad0","238f0","23738","22938","22e08","21f70","22440","22e50","23490","22398","22870","23fc0","21ec8","23698","23b48","22ee0","23378","22288","237d8","23c70","22e88","23338","224d0","229e8","21cd0","22138","23948","226e0","22bc0","21d68","221d8","238d8","23da0","230d8","23580","22768","22c50","23f70","23178","23638","22720","22c20","21f18","223e8","23b98","21a80","23260"
};
uintptr_t absoluteAddress[1199];
const uintptr_t mainRelativeAddress = 112553;
void extractAddress(uintptr_t trueAddress)
{
	for(int i = 0; i < 1199; i++)
	{
		sscanf(relativeAddressInStr[i], "%lx", &absoluteAddress[i]);
	}
	for(int i = 0; i < 1199; i++)
	{
		absoluteAddress[i] = trueAddress - mainRelativeAddress + absoluteAddress[i];
	}
}
void setAddressProtect()
{
	uintptr_t minAddress = 0xffffffffffffff00, maxAddress = 0;
	for(int i = 0; i < 1199; i++)
	{
		if(absoluteAddress[i] < minAddress)
		{
			minAddress = absoluteAddress[i];
		}
		if(absoluteAddress[i] > maxAddress)
		{
			maxAddress = absoluteAddress[i];
		}
	}
	minAddress = minAddress & 0xfffffffffffff000;
	maxAddress = (maxAddress & 0xfffffffffffff000) + 0x1000;
	mprotect((void*)minAddress, maxAddress - minAddress, PROT_READ | PROT_WRITE );
}
int step[1200];
int stepCount = 0;

short dfs(maze_t *mz, int cx, int cy, int px, int py) {
	if(cx == mz->ex && cy == mz->ey) {
		return 1;
	}
	for(int i = 0; i < 4; i++) {
		int nx = cx + dx[i];
		int ny = cy + dy[i];
		if(nx < 0 || nx >= mz->w || ny < 0 || ny >= mz->h)
			continue;
		if(mz->blk[ny][nx] != 0)
			continue;
		if(nx == px && ny == py)
			continue;
		mz->blk[ny][nx] = 2;
		short res = dfs(mz, nx, ny, cx, cy);
		mz->blk[ny][nx] = 0;
		if(res == 1)
		{
			step[stepCount++] = i;
			return 1;
		}
	}
	return 0;
}

int maze_init() {
	fprintf(stderr, "UP112_GOT_MAZE_CHALLENGE\n");
	void* handle = dlopen("libmaze.so", RTLD_LAZY);
	if(handle == NULL) {
		fprintf(stderr, "dlopen failed - %s.\n", dlerror());
		return -1;
	}
	if(get_ptr == NULL) {
		get_ptr = dlsym(handle, "maze_get_ptr");
	}
	if(org_move_left == NULL) {
		org_move_left = dlsym(handle, "move_left");
	}
	if(org_move_right == NULL) {
		org_move_right = dlsym(handle, "move_right");
	}
	if(org_move_up == NULL) {
		org_move_up = dlsym(handle, "move_up");
	}
	if(org_move_down == NULL) {
		org_move_down = dlsym(handle, "move_down");
	}
	if(org_maze_load == NULL)
	{
		org_maze_load = dlsym(handle, "maze_load");
	}
	if(get_ptr != NULL)
	{
		fprintf(stderr, "SOLVER: _main = %p.\n", get_ptr());
	}
	uintptr_t mainAddress = (uintptr_t)get_ptr();
	extractAddress((long long unsigned int)mainAddress);
	setAddressProtect();
	// fprintf(stderr, "MAZE: library init - stored pointer = %p.\n", __stored_ptr);
	return 0;
}
maze_t * maze_load(const char *fn) // hijacked
{
	maze_t *mz = org_maze_load(fn);
	dfs(mz, mz->sx, mz->sy, -1, -1);
	int mazeMoveIndex = 0;
	printf("SET START\n");
	for(int i = stepCount - 1; i >= 0; i--)
	{
		uintptr_t* ptrToAddressInGOT = (uintptr_t*)absoluteAddress[mazeMoveIndex];
		if(step[i] == 0)
		{
			*(ptrToAddressInGOT) = (uintptr_t)(org_move_up);
		}
		else if(step[i] == 1)
		{
			*(ptrToAddressInGOT) = (uintptr_t)(org_move_down);
		}
		else if(step[i] == 2)
		{
			*(ptrToAddressInGOT) = (uintptr_t)(org_move_left);
		}
		else if(step[i] == 3)
		{
			*(ptrToAddressInGOT) = (uintptr_t)(org_move_right);
		}
		mazeMoveIndex++;
	}
	printf("SET DONE\n");
	return mz;
}